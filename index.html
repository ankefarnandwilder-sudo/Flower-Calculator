<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Preisrechner – offline</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --line:#e5e7eb;

      /* Akzentfarben (Salbei & Sand) */
      --sage:#4f6f64;
      --sand:#8a6a4d;

      --btnText:#ffffff;
      --btnBorder:#d1d5db;
      --shadow:0 1px 0 rgba(0,0,0,.04);
      --radius:12px;
    }

    *{box-sizing:border-box}
    body{
      margin:16px;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .wrap{max-width:920px;margin:0 auto}

    h1{
      margin:0 0 10px;
      text-align:center;
      font-size:1.35rem;
      letter-spacing:.2px;
    }
    .sub{
      text-align:center;
      color:var(--muted);
      margin:0 0 14px;
      font-size:.95rem;
    }

    .topbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
      margin:12px 0 14px;
    }

    button{
      border:1px solid var(--btnBorder);
      background:#f7f7f7;
      color:var(--text);
      border-radius:10px;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
      min-height:44px;
      box-shadow:var(--shadow);
    }
    button:hover{border-color:#9ca3af}
    .btn-sage{background:var(--sage);border-color:transparent;color:var(--btnText)}
    .btn-sand{background:var(--sand);border-color:transparent;color:var(--btnText)}
    .btn-ghost{background:#fff}

    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:#fff;
      overflow:hidden;
      box-shadow:var(--shadow);
    }

    .tablewrap{
      max-height:62vh;
      overflow:auto;
    }

    table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
    }

    th,td{
      border-bottom:1px solid var(--line);
      padding:10px 8px;
      vertical-align:top;
    }

    th{
      position:sticky;
      top:0;
      z-index:2;
      background:#f3f4f6;
      color:#111827;
      font-size:.92rem;
      text-align:left;
    }

    /* Spaltenbreiten mobilfreundlich */
    col.col-item{width:40%}
    col.col-price{width:20%}
    col.col-qty{width:14%}
    col.col-sum{width:26%}

    input[type="text"], input[type="number"]{
      width:100%;
      min-height:42px;
      padding:10px 10px;
      border:1px solid #cfcfcf;
      border-radius:10px;
      font-size:16px;
      background:#fff;
    }
    input:focus{
      outline:none;
      border-color:#93c5fd;
      box-shadow:0 0 0 3px rgba(147,197,253,.25);
    }

    .num{ text-align:right; font-variant-numeric:tabular-nums; }

    .sumcell{
      font-variant-numeric:tabular-nums;
    }

    .sumwrap{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
    }

    .sumtext{
      width:100%;
      text-align:right;
      font-weight:900;
      color:#111827;
    }

    .actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .smallbtn{
      padding:8px 10px;
      min-height:38px;
      font-weight:800;
      border-radius:10px;
      background:#fff;
    }

    .footerbar{
      margin-top:12px;
      display:flex;
      justify-content:center;
    }

    .total{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      text-align:center;
      font-weight:900;
      font-size:1.25rem;
      background:#fafafa;
      position:sticky;
      bottom:10px;
      box-shadow:var(--shadow);
    }

    .hint{
      color:var(--muted);
      font-size:.9rem;
      line-height:1.35;
      margin-top:10px;
      text-align:center;
    }

    @media (max-width:520px){
      body{margin:12px}
      col.col-item{width:38%}
      col.col-price{width:22%}
      col.col-qty{width:14%}
      col.col-sum{width:26%}
      th,td{padding:10px 6px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Preisrechner – offline</h1>
    <div class="sub">Schnelle Preisberechnung. Speichert lokal im Browser (keine Cloud).</div>

    <div class="topbar">
      <button class="btn-sage" id="btnSave">Speichern</button>
      <button class="btn-sand" id="btnRestore">Wiederherstellen</button>
      <button class="btn-ghost" id="btnResetQty">Mengen zurücksetzen</button>
      <button class="btn-ghost" id="btnAddRow">Zeile hinzufügen</button>
    </div>

    <div class="card">
      <div class="tablewrap">
        <table>
          <colgroup>
            <col class="col-item" />
            <col class="col-price" />
            <col class="col-qty" />
            <col class="col-sum" />
          </colgroup>
          <thead>
            <tr>
              <th>Artikel / Produkt / Leistung</th>
              <th class="num">Einzelpreis (€)</th>
              <th class="num">Menge</th>
              <th class="num">Summe</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="footerbar">
      <div class="total">Gesamt: <span id="grandTotal">0,00&nbsp;€</span></div>
    </div>

    <div class="hint">
      Einzelpreis: einfach <b>450</b> tippen → wird <b>4,50</b> (Komma optional).<br/>
      Alles bleibt auf deinem Gerät.
    </div>
  </div>

  <script>
    const DEFAULT_ROWS = 15;
    const KEY_DRAFT = "pricecalc_draft_v1";
    const KEY_SAVED = "pricecalc_saved_v1";

    const tbody = document.getElementById("tbody");
    const grandTotalEl = document.getElementById("grandTotal");

    const fmtEUR = (cents) => {
      const n = (cents || 0) / 100;
      return n.toLocaleString("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "\u00A0€";
    };

    const clampInt = (v) => {
      const n = parseInt(v, 10);
      return Number.isFinite(n) && n >= 0 ? n : 0;
    };

    // "450" => 4,50 | "4,5" => 4,50 | "4.50" => 4,50
    function parsePriceToCents(raw){
      const s = String(raw ?? "").trim();
      if (s === "") return 0;

      if (/^\d+$/.test(s)) return Math.min(parseInt(s,10), 999999999);

      const normalized = s.replace(/\s/g,"").replace(",",".");
      const num = Number(normalized);
      if (!Number.isFinite(num) || num < 0) return 0;
      return Math.round(num * 100);
    }

    function formatCentsToInput(cents){
      const n = (cents || 0) / 100;
      return n.toLocaleString("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function readRow(tr){
      const { inpItem, inpPrice, inpQty } = tr._refs;
      return {
        item: inpItem.value ?? "",
        priceCents: parsePriceToCents(inpPrice.value),
        qty: clampInt(inpQty.value)
      };
    }

    function hookRowEvents(tr){
      const { inpItem, inpPrice, inpQty } = tr._refs;

      inpPrice.addEventListener("focus", () => inpPrice.select());

      inpPrice.addEventListener("blur", () => {
        const cents = parsePriceToCents(inpPrice.value);
        inpPrice.value = formatCentsToInput(cents);
        updateAll();
        saveDraft();
      });

      inpPrice.addEventListener("input", () => {
        updateAll(true);
        saveDraftThrottled();
      });

      inpQty.addEventListener("input", () => {
        inpQty.value = clampInt(inpQty.value);
        updateAll();
        saveDraftThrottled();
      });

      inpItem.addEventListener("input", () => saveDraftThrottled());
    }

    function makeRow(data = {}){
      const tr = document.createElement("tr");

      const tdItem = document.createElement("td");
      const inpItem = document.createElement("input");
      inpItem.type = "text";
      inpItem.value = data.item ?? "";
      tdItem.appendChild(inpItem);

      const tdPrice = document.createElement("td");
      const inpPrice = document.createElement("input");
      inpPrice.type = "text";
      inpPrice.inputMode = "decimal";
      inpPrice.className = "num";
      const priceCents = typeof data.priceCents === "number" ? data.priceCents : 0;
      inpPrice.value = formatCentsToInput(priceCents); // startet als 0,00
      tdPrice.appendChild(inpPrice);

      const tdQty = document.createElement("td");
      const inpQty = document.createElement("input");
      inpQty.type = "number";
      inpQty.inputMode = "numeric";
      inpQty.min = "0";
      inpQty.step = "1";
      inpQty.className = "num";
      inpQty.value = (typeof data.qty === "number" ? data.qty : 0);
      tdQty.appendChild(inpQty);

      const tdSum = document.createElement("td");
      tdSum.className = "sumcell";

      const sumWrap = document.createElement("div");
      sumWrap.className = "sumwrap";

      const sumText = document.createElement("div");
      sumText.className = "sumtext";
      sumText.textContent = "—";

      const act = document.createElement("div");
      act.className = "actions";

      const btnInsert = document.createElement("button");
      btnInsert.type = "button";
      btnInsert.className = "smallbtn";
      btnInsert.textContent = "Zeile einfügen";
      btnInsert.onclick = () => {
        const newTr = makeRow({ item:"", priceCents:0, qty:0 });
        tr.parentElement.insertBefore(newTr, tr.nextSibling);
        hookRowEvents(newTr);
        updateAll();
        saveDraft();
      };

      const btnDup = document.createElement("button");
      btnDup.type = "button";
      btnDup.className = "smallbtn";
      btnDup.textContent = "Duplizieren";
      btnDup.onclick = () => {
        const snap = readRow(tr);
        const newTr = makeRow(snap);
        tr.parentElement.insertBefore(newTr, tr.nextSibling);
        hookRowEvents(newTr);
        updateAll();
        saveDraft();
      };

      const btnDel = document.createElement("button");
      btnDel.type = "button";
      btnDel.className = "smallbtn";
      btnDel.textContent = "Löschen";
      btnDel.onclick = () => {
        tr.remove();
        updateAll();
        saveDraft();
      };

      act.appendChild(btnInsert);
      act.appendChild(btnDup);
      act.appendChild(btnDel);

      sumWrap.appendChild(sumText);
      sumWrap.appendChild(act);
      tdSum.appendChild(sumWrap);

      tr.appendChild(tdItem);
      tr.appendChild(tdPrice);
      tr.appendChild(tdQty);
      tr.appendChild(tdSum);

      tr._refs = { inpItem, inpPrice, inpQty, sumText };
      hookRowEvents(tr);

      return tr;
    }

    function updateAll(){
      let grand = 0;
      Array.from(tbody.children).forEach(tr => {
        const { sumText, inpPrice, inpQty } = tr._refs;

        const priceCents = parsePriceToCents(inpPrice.value);
        const qty = clampInt(inpQty.value);

        const rowSum = priceCents * qty;
        if (rowSum === 0){
          sumText.textContent = "—";
          sumText.style.color = "#6b7280";
        } else {
          sumText.textContent = fmtEUR(rowSum);
          sumText.style.color = "#111827";
        }
        grand += rowSum;
      });

      grandTotalEl.innerHTML = fmtEUR(grand).replace(" €","&nbsp;€");
    }

    function getSnapshot(){
      return Array.from(tbody.children).map(readRow);
    }

    function applySnapshot(rows){
      tbody.innerHTML = "";
      const list = Array.isArray(rows) ? rows : [];
      const toRender = list.length ? list : Array.from({length:DEFAULT_ROWS}, () => ({item:"", priceCents:0, qty:0}));
      toRender.forEach(r => tbody.appendChild(makeRow(r)));
      updateAll();
    }

    function saveDraft(){
      try{
        localStorage.setItem(KEY_DRAFT, JSON.stringify({ savedAt: Date.now(), rows: getSnapshot() }));
      } catch {}
    }

    let _t = null;
    function saveDraftThrottled(){
      clearTimeout(_t);
      _t = setTimeout(saveDraft, 250);
    }

    function saveManual(){
      try{
        localStorage.setItem(KEY_SAVED, JSON.stringify({ savedAt: Date.now(), rows: getSnapshot() }));
        alert("Gespeichert (lokal im Browser).");
      } catch {
        alert("Konnte nicht speichern (Browser-Speicher blockiert?).");
      }
    }

    function restoreManual(){
      try{
        const obj = JSON.parse(localStorage.getItem(KEY_SAVED) || "null");
        if (!obj || !obj.rows) {
          alert("Noch nichts gespeichert.");
          return;
        }
        applySnapshot(obj.rows);
        saveDraft();
      } catch {
        alert("Konnte nicht wiederherstellen.");
      }
    }

    function resetQuantities(){
      Array.from(tbody.children).forEach(tr => tr._refs.inpQty.value = 0);
      updateAll();
      saveDraft();
    }

    document.getElementById("btnAddRow").addEventListener("click", () => {
      tbody.appendChild(makeRow({ item:"", priceCents:0, qty:0 }));
      updateAll();
      saveDraft();
    });

    document.getElementById("btnResetQty").addEventListener("click", resetQuantities);
    document.getElementById("btnSave").addEventListener("click", saveManual);
    document.getElementById("btnRestore").addEventListener("click", restoreManual);

    (function init(){
      // Standard-Zeilen
      for (let i=0;i<DEFAULT_ROWS;i++){
        tbody.appendChild(makeRow({ item:"", priceCents:0, qty:0 }));
      }

      // Draft automatisch wiederherstellen
      try{
        const draft = JSON.parse(localStorage.getItem(KEY_DRAFT) || "null");
        if (draft && draft.rows) applySnapshot(draft.rows);
        else updateAll();
      } catch {
        updateAll();
      }

      saveDraft();
    })();
  </script>
</body>
</html>

   

   
    
    
  
 
 



   
    


  





      

      

    
   
    
   
 

 
  
   
       

  

   




  


 

   
      
       
       
    
       
       
       
     

 
     
    
    
