<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Preisrechner offline</title>
  <style>
    :root{
      --sage: #6f8f7b;
      --sand: #8a7763;
      --white: #ffffff;
      --gray: #f3f4f4;
      --radius: 12px;
      --border: 1px solid rgba(138, 119, 99, 0.35);
      --border-strong: 1px solid rgba(138, 119, 99, 0.7);
      --pad: 12px;
    }

    *{ box-sizing: border-box; }
    html, body{ height: 100%; }
    body{
      margin: 0;
      background: var(--gray);
      color: var(--sand);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.35;
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 28px;
    }

    header{
      background: var(--white);
      border: var(--border);
      border-radius: calc(var(--radius) + 4px);
      padding: 16px 14px 14px;
    }

    h1{
      margin: 0;
      font-size: 20px;
      font-weight: 650;
      letter-spacing: 0.2px;
      color: var(--sand);
    }

    .sub{
      margin: 6px 0 0;
      font-size: 12px;
      color: rgba(138, 119, 99, 0.85);
    }

    .panel{
      margin-top: 12px;
      background: var(--white);
      border: var(--border);
      border-radius: calc(var(--radius) + 4px);
      padding: 12px 12px 10px;
    }

    .topbar{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: stretch;
    }

    .btn{
      flex: 1 1 160px;
      height: 42px;
      border-radius: var(--radius);
      border: var(--border-strong);
      background: var(--gray);
      color: var(--sand);
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.15px;
      padding: 0 10px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .btn:active{ transform: translateY(0.5px); }
    .btn:focus{ outline: none; border: var(--border-strong); }

    .btn.primary{
      background: var(--sage);
      border: 1px solid rgba(111, 143, 123, 0.75);
      color: var(--white);
    }

    .btn.secondary{
      background: var(--sand);
      border: 1px solid rgba(138, 119, 99, 0.75);
      color: var(--white);
    }

    .status{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(138, 119, 99, 0.85);
      min-height: 16px;
    }

    .sheet{
      margin-top: 12px;
      border-radius: calc(var(--radius) + 4px);
      border: var(--border);
      overflow: hidden;
      background: var(--white);
    }

    .headrow, .row{
      display: grid;
      grid-template-columns: minmax(180px, 2.2fr) minmax(110px, 1fr) minmax(90px, 0.8fr) minmax(120px, 1fr) 44px;
      gap: 10px;
      align-items: center;
      padding: 10px 10px;
    }

    .headrow{
      background: var(--gray);
      border-bottom: var(--border);
      font-size: 12px;
      font-weight: 700;
      color: rgba(138, 119, 99, 0.9);
    }

    .row{
      border-bottom: 1px solid rgba(138, 119, 99, 0.22);
      background: var(--white);
    }
    .row:last-child{ border-bottom: none; }

    .cell{
      min-width: 0;
    }

    input[type="text"], input[type="number"]{
      width: 100%;
      height: 40px;
      border-radius: var(--radius);
      border: var(--border);
      background: var(--white);
      color: var(--sand);
      font-size: 14px;
      padding: 0 10px;
      outline: none;
    }
    input[type="text"]:focus, input[type="number"]:focus{
      border: 1px solid rgba(111, 143, 123, 0.85);
    }

    input[type="number"]{
      padding-right: 6px;
    }

    .sum{
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 10px;
      border-radius: var(--radius);
      border: var(--border);
      background: var(--gray);
      color: var(--sand);
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .actions{
      display: flex;
      gap: 6px;
      justify-content: flex-end;
      align-items: center;
    }

    .iconbtn{
      width: 22px;
      height: 22px;
      border-radius: 8px;
      border: var(--border);
      background: var(--white);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      color: rgba(138, 119, 99, 0.9);
      -webkit-tap-highlight-color: transparent;
    }
    .iconbtn:focus{ outline: none; border: 1px solid rgba(111, 143, 123, 0.85); }
    .iconbtn:active{ transform: translateY(0.5px); }

    .iconbtn svg{
      width: 12px;
      height: 12px;
      display: block;
      fill: currentColor;
    }

    .footer{
      margin-top: 12px;
      background: var(--white);
      border: var(--border);
      border-radius: calc(var(--radius) + 4px);
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .total-label{
      font-size: 14px;
      font-weight: 700;
      color: rgba(138, 119, 99, 0.92);
      white-space: nowrap;
    }

    .total-value{
      font-size: 18px;
      font-weight: 750;
      color: var(--sand);
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }

    .empty{
      padding: 14px 12px;
      border-top: var(--border);
      background: var(--white);
      font-size: 13px;
      color: rgba(138, 119, 99, 0.85);
    }

    @media (max-width: 520px){
      .wrap{ padding: 14px 12px 22px; }
      header{ padding: 14px 12px 12px; }
      h1{ font-size: 18px; }
      .btn{ flex: 1 1 calc(50% - 10px); }
      .headrow, .row{
        grid-template-columns: minmax(160px, 2.2fr) minmax(98px, 1fr) minmax(86px, 0.8fr) minmax(110px, 1fr) 44px;
        gap: 8px;
        padding: 10px 10px;
      }
      input[type="text"], input[type="number"], .sum{ height: 38px; font-size: 14px; }
      .sum{ padding: 0 9px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Preisrechner offline</h1>
      <p class="sub">Artikel / Produkt / Leistung, Einzelpreis und Menge eingeben – Summen werden automatisch berechnet. Speicherung lokal im Browser (keine Cloud).</p>
    </header>

    <section class="panel" aria-label="Aktionen">
      <div class="topbar">
        <button class="btn primary" id="addRowBtn" type="button">Artikel hinzufügen</button>
        <button class="btn secondary" id="saveBtn" type="button">Speichern</button>
        <button class="btn" id="restoreBtn" type="button">Wiederherstellen</button>
        <button class="btn" id="resetQtyBtn" type="button">Mengen zurücksetzen</button>
      </div>
      <div class="status" id="status" aria-live="polite"></div>
    </section>

    <section class="sheet" aria-label="Preisrechner">
      <div class="headrow" role="row">
        <div class="cell" role="columnheader">Artikel / Produkt / Leistung</div>
        <div class="cell" role="columnheader">Einzelpreis (€)</div>
        <div class="cell" role="columnheader">Menge</div>
        <div class="cell" role="columnheader" style="text-align:right;">Summe</div>
        <div class="cell" role="columnheader" style="text-align:right;">&nbsp;</div>
      </div>
      <div id="rows"></div>
      <div id="emptyState" class="empty" hidden>Keine Zeilen vorhanden.</div>
    </section>

    <section class="footer" aria-label="Gesamtsumme">
      <div class="total-label">Gesamtsumme</div>
      <div class="total-value" id="grandTotal">0,00&nbsp;€</div>
    </section>
  </div>

  <script>
    (function(){
      const STORAGE_KEY = "preisrechner_offline_state_v1";

      const rowsEl = document.getElementById("rows");
      const emptyEl = document.getElementById("emptyState");
      const grandTotalEl = document.getElementById("grandTotal");
      const statusEl = document.getElementById("status");

      const addRowBtn = document.getElementById("addRowBtn");
      const saveBtn = document.getElementById("saveBtn");
      const restoreBtn = document.getElementById("restoreBtn");
      const resetQtyBtn = document.getElementById("resetQtyBtn");

      const nf = new Intl.NumberFormat("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

      function nowText(){
        const d = new Date();
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        const ss = String(d.getSeconds()).padStart(2, "0");
        return `${hh}:${mm}:${ss}`;
      }

      let statusTimer = null;
      function setStatus(text){
        statusEl.textContent = text || "";
        if(statusTimer) clearTimeout(statusTimer);
        if(text){
          statusTimer = setTimeout(() => { statusEl.textContent = ""; }, 2500);
        }
      }

      function formatMoneyValue(valueNumber){
        const v = Number.isFinite(valueNumber) ? valueNumber : 0;
        return nf.format(v);
      }

      function moneyToCentsFromInput(raw){
        const s0 = String(raw ?? "").trim();
        if(!s0) return 0;

        let s = s0.replace(/\s+/g, "");
        s = s.replace(/-/g, "");
        s = s.replace(/[^\d.,]/g, "");

        if(!s) return 0;

        const hasComma = s.includes(",");
        const hasDot = s.includes(".");
        let normalized = s;

        if(hasComma){
          const parts = normalized.split(",");
          const dec = parts.pop() ?? "";
          const intPart = parts.join("").replace(/\./g, "");
          normalized = intPart + "." + dec;
        } else if(hasDot){
          const parts = normalized.split(".");
          const dec = parts.pop() ?? "";
          const intPart = parts.join("");
          normalized = intPart + "." + dec;
        } else {
          normalized = normalized;
        }

        let num = Number(normalized);
        if(!Number.isFinite(num) || num < 0) num = 0;

        const cents = Math.round(num * 100);
        return cents < 0 ? 0 : cents;
      }

      function centsToMoney(cents){
        const c = Number.isFinite(cents) ? Math.max(0, Math.round(cents)) : 0;
        return c / 100;
      }

      function clampInt(v){
        const n = Number(v);
        if(!Number.isFinite(n)) return 0;
        const i = Math.trunc(n);
        return i < 0 ? 0 : i;
      }

      function computeRowCents(row){
        const cents = moneyToCentsFromInput(row.priceText);
        const qty = clampInt(row.qty);
        return cents * qty;
      }

      function computeGrandTotalCents(state){
        return state.rows.reduce((sum, r) => sum + computeRowCents(r), 0);
      }

      function defaultRow(){
        return { item: "", priceText: "0,00", qty: 0 };
      }

      let state = { rows: [defaultRow()] };

      function render(){
        rowsEl.innerHTML = "";
        const hasRows = state.rows.length > 0;
        emptyEl.hidden = hasRows;

        state.rows.forEach((row, idx) => {
          const rowEl = document.createElement("div");
          rowEl.className = "row";
          rowEl.dataset.index = String(idx);

          const itemCell = document.createElement("div");
          itemCell.className = "cell";
          const itemInput = document.createElement("input");
          itemInput.type = "text";
          itemInput.value = row.item ?? "";
          itemInput.setAttribute("aria-label", "Artikel / Produkt / Leistung");
          itemInput.addEventListener("input", () => {
            state.rows[idx].item = itemInput.value;
            scheduleAutoSave();
          });
          itemCell.appendChild(itemInput);

          const priceCell = document.createElement("div");
          priceCell.className = "cell";
          const priceInput = document.createElement("input");
          priceInput.type = "text";
          priceInput.inputMode = "decimal";
          priceInput.autocomplete = "off";
          priceInput.spellcheck = false;
          priceInput.value = (row.priceText == null || row.priceText === "") ? "0,00" : String(row.priceText);
          priceInput.setAttribute("aria-label", "Einzelpreis in Euro");
          priceInput.addEventListener("focus", () => {
            try{ priceInput.select(); } catch(_){}
          });
          priceInput.addEventListener("input", () => {
            let v = priceInput.value;
            v = v.replace(/-/g, "");
            state.rows[idx].priceText = v;
            updateRowSum(idx, rowEl);
            updateGrandTotal();
            scheduleAutoSave();
          });
          priceInput.addEventListener("blur", () => {
            const cents = moneyToCentsFromInput(priceInput.value);
            const formatted = formatMoneyValue(centsToMoney(cents));
            priceInput.value = formatted;
            state.rows[idx].priceText = formatted;
            updateRowSum(idx, rowEl);
            updateGrandTotal();
            scheduleAutoSave();
          });
          priceCell.appendChild(priceInput);

          const qtyCell = document.createElement("div");
          qtyCell.className = "cell";
          const qtyInput = document.createElement("input");
          qtyInput.type = "number";
          qtyInput.min = "0";
          qtyInput.step = "1";
          qtyInput.value = String(clampInt(row.qty));
          qtyInput.setAttribute("aria-label", "Menge");
          qtyInput.addEventListener("input", () => {
            const q = clampInt(qtyInput.value);
            qtyInput.value = String(q);
            state.rows[idx].qty = q;
            updateRowSum(idx, rowEl);
            updateGrandTotal();
            scheduleAutoSave();
          });
          qtyCell.appendChild(qtyInput);

          const sumCell = document.createElement("div");
          sumCell.className = "cell";
          const sumBox = document.createElement("div");
          sumBox.className = "sum";
          sumBox.setAttribute("aria-label", "Summe der Zeile");
          sumBox.style.textAlign = "right";
          sumBox.dataset.role = "rowsum";
          sumBox.textContent = formatMoneyValue(centsToMoney(computeRowCents(row))) + "\u00A0€";
          sumCell.appendChild(sumBox);

          const actionsCell = document.createElement("div");
          actionsCell.className = "cell";
          const actions = document.createElement("div");
          actions.className = "actions";

          const dupBtn = iconButton("Duplizieren", svgDuplicate());
          dupBtn.addEventListener("click", () => {
            const copy = {
              item: state.rows[idx].item ?? "",
              priceText: (state.rows[idx].priceText == null || state.rows[idx].priceText === "") ? "0,00" : String(state.rows[idx].priceText),
              qty: clampInt(state.rows[idx].qty)
            };
            state.rows.splice(idx + 1, 0, copy);
            render();
            updateGrandTotal();
            saveAuto();
            setStatus("Dupliziert (" + nowText() + ")");
          });

          const insBtn = iconButton("Zeile einfügen (darunter)", svgInsertBelow());
          insBtn.addEventListener("click", () => {
            state.rows.splice(idx + 1, 0, defaultRow());
            render();
            updateGrandTotal();
            saveAuto();
            setStatus("Eingefügt (" + nowText() + ")");
          });

          const delBtn = iconButton("Löschen", svgTrash());
          delBtn.addEventListener("click", () => {
            state.rows.splice(idx, 1);
            render();
            updateGrandTotal();
            saveAuto();
            setStatus("Gelöscht (" + nowText() + ")");
          });

          actions.appendChild(dupBtn);
          actions.appendChild(insBtn);
          actions.appendChild(delBtn);
          actionsCell.appendChild(actions);

          rowEl.appendChild(itemCell);
          rowEl.appendChild(priceCell);
          rowEl.appendChild(qtyCell);
          rowEl.appendChild(sumCell);
          rowEl.appendChild(actionsCell);

          rowsEl.appendChild(rowEl);
        });

        updateGrandTotal();
      }

      function iconButton(title, svgEl){
        const b = document.createElement("button");
        b.type = "button";
        b.className = "iconbtn";
        b.title = title;
        b.setAttribute("aria-label", title);
        b.appendChild(svgEl);
        return b;
      }

      function svgDuplicate(){
        const s = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        s.setAttribute("viewBox", "0 0 24 24");
        const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
        p.setAttribute("d","M8 8h10v10H8V8zm-2 2H5V5h10v1H6v4zm0 0v9h9v-1H7v-8H6z");
        s.appendChild(p);
        return s;
      }

      function svgInsertBelow(){
        const s = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        s.setAttribute("viewBox", "0 0 24 24");
        const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
        p.setAttribute("d","M4 6h16v2H4V6zm8 4v4h4v2h-4v4h-2v-4H6v-2h4v-4h2z");
        s.appendChild(p);
        return s;
      }

      function svgTrash(){
        const s = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        s.setAttribute("viewBox", "0 0 24 24");
        const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
        p.setAttribute("d","M9 3h6l1 2h5v2H3V5h5l1-2zm1 6h2v10h-2V9zm4 0h2v10h-2V9zM7 9h2v10H7V9z");
        s.appendChild(p);
        return s;
      }

      function updateRowSum(idx, rowEl){
        const sumBox = rowEl.querySelector('[data-role="rowsum"]');
        if(!sumBox) return;
        const row = state.rows[idx];
        const cents = computeRowCents(row);
        sumBox.textContent = formatMoneyValue(centsToMoney(cents)) + "\u00A0€";
      }

      function updateGrandTotal(){
        const totalCents = computeGrandTotalCents(state);
        grandTotalEl.textContent = formatMoneyValue(centsToMoney(totalCents)) + "\u00A0€";
      }

      function serializeState(){
        const rows = (state.rows || []).map(r => ({
          item: String(r.item ?? ""),
          priceText: (r.priceText == null || r.priceText === "") ? "0,00" : String(r.priceText),
          qty: clampInt(r.qty)
        }));
        return { rows };
      }

      function applyState(obj){
        const rows = Array.isArray(obj?.rows) ? obj.rows : [];
        state.rows = rows.map(r => ({
          item: String(r?.item ?? ""),
          priceText: (r?.priceText == null || r?.priceText === "") ? "0,00" : String(r.priceText),
          qty: clampInt(r?.qty)
        }));
        render();
      }

      function saveManual(){
        const payload = serializeState();
        try{
          localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
          setStatus("Gespeichert (" + nowText() + ")");
        }catch(_){
          setStatus("Speichern nicht möglich (" + nowText() + ")");
        }
      }

      function restore(){
        let raw = null;
        try{
          raw = localStorage.getItem(STORAGE_KEY);
        }catch(_){
          setStatus("Wiederherstellen nicht möglich (" + nowText() + ")");
          return;
        }
        if(!raw){
          setStatus("Kein gespeicherter Zustand (" + nowText() + ")");
          return;
        }
        try{
          const obj = JSON.parse(raw);
          applyState(obj);
          setStatus("Wiederhergestellt (" + nowText() + ")");
        }catch(_){
          setStatus("Gespeicherter Zustand ungültig (" + nowText() + ")");
        }
      }

      function resetQuantities(){
        state.rows = (state.rows || []).map(r => ({
          item: String(r.item ?? ""),
          priceText: (r.priceText == null || r.priceText === "") ? "0,00" : String(r.priceText),
          qty: 0
        }));
        render();
        saveAuto();
        setStatus("Mengen zurückgesetzt (" + nowText() + ")");
      }

      function addRow(){
        state.rows.push(defaultRow());
        render();
        saveAuto();
        setStatus("Zeile hinzugefügt (" + nowText() + ")");
      }

      let saveTimer = null;
      function scheduleAutoSave(){
        if(saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(() => {
          saveAuto();
        }, 300);
      }

      function saveAuto(){
        const payload = serializeState();
        try{
          localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
        }catch(_){}
      }

      addRowBtn.addEventListener("click", addRow);
      saveBtn.addEventListener("click", saveManual);
      restoreBtn.addEventListener("click", restore);
      resetQtyBtn.addEventListener("click", resetQuantities);

      (function init(){
        let loaded = false;
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(raw){
            const obj = JSON.parse(raw);
            applyState(obj);
            loaded = true;
          }
        }catch(_){}
        if(!loaded) render();
        updateGrandTotal();
      })();
    })();
  </script>
</body>
</html>

 




  

  


   

   

   
    
    
  
 
 



   
    


  





      

      

    
   
    
   
 

 
  
   
       

  

   




  


 

   
      
       
       
    
       
       
       
     

 
     
    
    
